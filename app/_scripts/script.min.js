/*! xl-platform-fighter 2016-09-22 */
"use strict";function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),Character=function(){function a(b,c,d){_classCallCheck(this,a),this.game=b,this.startPosX=c,this.startPosY=d,this.stocks=this.game.startingStockCount}return _createClass(a,[{key:"initialise",value:function(a){this.id=a.id,this.name=a.name,this.maxSpeed=a.maxSpeed/this.game.fps,this.acceleration=a.acceleration,this.deceleration=a.deceleration,this.turnDelay=a.turnDelay,this.hurtboxes=a.hurtboxes,this.hitboxes=a.hitboxes,this.weight=1/a.weight,this.airSpeed=a.airSpeed/this.game.fps,this.jumpPower=1/a.jumpPower,this.jumpHeight=a.jumpHeight,this.allowedJumps=a.allowedJumps,this.jumpThreshold=a.jumpThreshold,this.keysHeld={},this.currentSpeed=0,this.currentFallSpeed=0,this.currentDir=a.currentDir,this.currentVerticalDir=1,this.jumpStart=this.hurtboxes[0].y,this.jumpsRemaining=a.allowedJumps,this.jumping=!1,this.stun=!1,this.invulnerable=!1,this.visibleHitboxes=[]}},{key:"drawActions",value:function(a){if(this.fall(a.gravity,a.floors),this.game.currentKeys[this.keyBindings.basicAttack]&&!this.stun?(this.keysHeld[this.keyBindings.basicAttack]===!1&&(this.keysHeld[this.keyBindings.basicAttack]=!0,this.hitboxes.basicAttack[0].currentFrame>this.hitboxes.basicAttack[0].endFrame+this.hitboxes.basicAttack[0].cooldown&&(this.hitboxes.basicAttack[0].currentFrame=0)),this.hitboxes.basicAttack[0].currentFrame>this.hitboxes.basicAttack[0].endFrame+this.hitboxes.basicAttack[0].cooldown?this.keysHeld[this.keyBindings.basicAttack]===!1&&(this.hitboxes.basicAttack[0].currentFrame=0):this.visibleHitboxes=this.hitboxes.basicAttack):this.keysHeld[this.keyBindings.basicAttack]=!1,this.stun?this.hitstun():this.game.currentKeys[this.keyBindings.right]?(this.game.keyChanged&&1!==this.currentDir&&this.turn(1),this.move()):this.game.currentKeys[this.keyBindings.left]?(this.game.keyChanged&&this.currentDir!==-1&&this.turn(-1),this.move()):this.stop(),this.game.currentKeys[this.keyBindings.jump]&&!this.stun){if(this.jumpHeld)return;if(this.jumpHeld=!0,this.jumpsRemaining>0){if(this.currentVerticalDir===-1&&this.jumpsRemaining<this.allowedJumps&&this.hurtboxes[0].y>this.jumpStart-this.jumpThreshold.up||1===this.currentVerticalDir&&this.jumpsRemaining<this.allowedJumps&&this.hurtboxes[0].y>this.jumpStart-this.jumpThreshold.down)return;this.jumpStart=this.hurtboxes[0].y,this.currentVerticalDir=-1,this.jumpsRemaining--}}else this.jumpHeld=!1;if(!this.invulnerable)for(var b=0;b<this.hurtboxes.length;b++)for(var c=this.hurtboxes[b],d=0;d<this.game.players.length;d++){var e=this.game.players[d].character;if(this!==e)for(var f=0;f<e.visibleHitboxes.length;f++){var g=e.visibleHitboxes[f];if(g.active&&c.x<g.calculatedX+g.width&&c.x+c.width>g.calculatedX&&c.y-c.height<e.hurtboxes[0].y-g.yOffset&&c.y>e.hurtboxes[0].y-g.yOffset-g.height){this.jumpStart=this.hurtboxes[0].y,this.getHit(g);break}}}(this.hurtboxes[0].x<0||this.hurtboxes[0].y<0||this.hurtboxes[0].x>this.game.canvas.width||this.hurtboxes[0].y>this.game.canvas.height)&&this.loseStock()}},{key:"loseStock",value:function(){this.stocks--,this.stocks<=0?this.game.gameOver():(this.hurtboxes[0].x=this.startPosX,this.hurtboxes[0].y=this.startPosY,this.currentSpeed=0)}},{key:"getHit",value:function(a){var b=a.angle/45;this.currentVerticalDir=-1,this.currentFallSpeed=this.currentVerticalDir*b*a.knockback,this.currentDir=a.dir,this.currentSpeed=1/b*a.knockback,this.invulnerable=!0;var c=this;setTimeout(function(){c.invulnerable=!1},100),setTimeout(function(){c.stun=!1},a.hitstun)}},{key:"hitstun",value:function(){}},{key:"move",value:function(){var a=this.maxSpeed;this.currentFallSpeed>0&&(a=this.airSpeed);var b=a/(this.acceleration*this.game.fps);this.currentSpeed<a&&(this.currentSpeed+=b);for(var c=0;c<this.hurtboxes.length;c++)this.hurtboxes[c].x+=this.currentDir*this.currentSpeed}},{key:"stop",value:function(){var a=this.maxSpeed/(this.deceleration*this.game.fps);this.currentFallSpeed>0&&(a/=3),this.currentSpeed>0&&(this.currentSpeed-=a,this.currentSpeed<0&&(this.currentSpeed=0));for(var b=0;b<this.hurtboxes.length;b++)this.hurtboxes[b].x+=this.currentDir*this.currentSpeed}},{key:"turn",value:function(a){if(0!==this.currentSpeed){var b=this.maxSpeed/(this.turnDelay*this.game.fps);this.currentSpeed>0&&(this.currentSpeed-=b,this.currentSpeed<0&&(this.currentSpeed=0)),0===this.currentSpeed&&(this.currentDir=a,this.game.keyChanged=!1)}}},{key:"fall",value:function(a,b){if(this.currentVerticalDir===-1)return void this.jump(a,b);this.currentFallSpeed>0&&(this.jumping=!1);for(var c=!1,d=0;d<this.hurtboxes.length;d++){for(var e=this.hurtboxes[d],f=0;f<b.length;f++){var g=b[f];!this.jumping&&e.y>=g.y&&1===this.currentVerticalDir&&e.y-e.height<=g.y&&(e.x>=g.x&&e.x<=g.x+g.width||e.x+e.width>=g.x&&e.x+e.width<=g.x+g.width)&&(c=!0,this.stun&&(this.stun=!1,this.currentSpeed=this.currentDir),this.hurtboxes[0].y=g.y)}if(c){this.jumpsRemaining=this.allowedJumps,this.currentFallSpeed=0;break}this.jumpsRemaining===this.allowedJumps&&(this.jumpsRemaining=this.allowedJumps-1),this.currentFallSpeed+=a/(this.weight*this.game.fps),e.y+=this.currentFallSpeed}}},{key:"jump",value:function(a,b){this.hurtboxes[0].y>this.jumpStart-this.jumpHeight?(this.currentFallSpeed-=a/(this.jumpPower*this.game.fps),this.hurtboxes[0].y+=this.currentFallSpeed,this.jumping=!0):this.stun||(this.currentVerticalDir=1)}}]),a}(),Hurtbox=function a(b,c,d,e){_classCallCheck(this,a),this.x=b,this.y=c,this.width=d,this.height=e},Hitbox=function a(b,c,d,e,f,g,h,i,j,k,l,m){_classCallCheck(this,a),this.xOffset=b,this.yOffset=c,this.width=d,this.height=e,this.damage=f,this.angle=g,this.knockback=h,this.growth=i,this.dir=1,this.startFrame=k,this.endFrame=l,this.cooldown=m,this.currentFrame=0,this.active=!1;var n=j||60;this.hitstun=n/60*1e3},_createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),Game=function(){function a(b,c,d,e){_classCallCheck(this,a),this.canvas=document.getElementById(b),this.canvas.width=c,this.canvas.height=d,this.fps=e,this.ctx=this.canvas.getContext("2d"),this.currentKeys=[],this.keyChanged=!1,this.startingStockCount=4,this.visibleHitboxes={},this.players=[]}return _createClass(a,[{key:"gameOver",value:function(){setTimeout(function(){clearInterval(window.drawScene)},100)}}]),a}(),Player=function a(b,c){_classCallCheck(this,a),this.character=b,this.character.keyBindings={left:c.left,jump:c.jump,right:c.right,basicAttack:c.basicAttack}},Scene=function(){function a(b,c,d){_classCallCheck(this,a),this.game=b,this.stage=c,this.players=d,this.game.players=d,window.drawScene=setInterval(this.draw.bind(this),1e3/this.game.fps)}return _createClass(a,[{key:"draw",value:function(){var a=document.createElement("canvas"),b=a.getContext("2d");a.height=this.game.canvas.height,a.width=this.game.canvas.width,this.game.ctx.clearRect(0,0,this.game.canvas.width,this.game.canvas.height),this.drawStageFloors(b),this.drawCharacters(b),this.drawCharacterStocks(b);for(var c=0;c<this.players.length;c++)this.characterActions(this.players[c].character),this.drawHitboxes(b,this.players[c].character);this.game.ctx.drawImage(a,0,0)}},{key:"drawStageFloors",value:function(a){for(var b=0;b<this.stage.floors.length;b++){var c=this.stage.floors[b];a.moveTo(c.x,c.y),a.lineTo(c.x+c.width,c.y),a.stroke()}}},{key:"drawCharacterStocks",value:function(a){for(var b=0;b<this.players[0].character.stocks;b++){var c=document.createElement("img");c.setAttribute("src","/stock-icons/"+this.players[0].character.id+".png"),a.drawImage(c,32+40*b,32)}}},{key:"drawCharacters",value:function(a){for(var b=0;b<this.players.length;b++)for(var c=0;c<this.players[b].character.hurtboxes.length;c++){var d=this.players[b].character.hurtboxes[c];a.rect(d.x,d.y-d.height,d.width,d.height),a.stroke()}}},{key:"characterActions",value:function(a){a.drawActions(this.stage)}},{key:"drawHitboxes",value:function(a,b){for(var c=0;c<b.visibleHitboxes.length;c++){var d=b.visibleHitboxes[c];if(d.currentFrame++,d.currentFrame>=d.startFrame&&d.currentFrame<=d.endFrame?d.active=!0:d.currentFrame>d.endFrame&&(d.active=!1),!d.active)return;var e=b.hurtboxes[0],f=e.x;1==b.currentDir&&(f+=e.width),d.dir=b.currentDir,d.calculatedX=f+d.xOffset*b.currentDir,a.strokeStyle="#FF0000",a.rect(d.calculatedX,e.y-d.yOffset,d.width,d.height),a.stroke(),a.strokeStyle="#000000"}}}]),a}();document.onkeydown=function(a){activeGame.currentKeys[a.keyCode]||(activeGame.keyChanged=!0,activeGame.currentKeys[a.keyCode]=!0)},document.onkeyup=function(a){activeGame.currentKeys[a.keyCode]=!1};var Stage=function a(b,c,d,e){_classCallCheck(this,a),this.game=b,this.name=c,this.floors=d,this.gravity=e/this.game.fps},Floor=function a(b,c,d){_classCallCheck(this,a),this.x=b,this.y=c,this.width=d};